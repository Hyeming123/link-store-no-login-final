<!doctype html>
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

    <title>Link Store</title>
    <style>
        body {
            background-color: #ffffff;
            color: #333333;
        }

        .navbar {
            background-color: #ffffff !important;
            border-bottom: 1px solid #e0e0e0;
        }

        /* ë¡œê³  ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .navbar-brand img {
            height: 40px;
            width: auto;
            margin-right: 5px;
            display: none;
        }

        /* ë¡œê³  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .navbar-brand .logo-text {
            font-size: 1.25rem;
            font-weight: bold;
            color: #333333;
        }

        /* ì‚¬ìš©ì ì •ë³´ ìŠ¤íƒ€ì¼ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .user-email {
            font-size: 14px;
            color: #666666;
        }

        .logout-btn {
            padding: 6px 12px;
            font-size: 14px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .auth-buttons {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        .auth-buttons a {
            padding: 6px 12px;
            font-size: 14px;
            text-decoration: none;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            transition: all 0.3s;
        }

        .auth-buttons a:first-child {
            background-color: #ffffff;
        }

        .auth-buttons a:first-child:hover {
            background-color: #007bff;
            color: white;
        }

        .auth-buttons a:last-child {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .auth-buttons a:last-child:hover {
            background-color: #218838;
            border-color: #218838;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
        }

        h1 {
            color: #333333;
            margin-bottom: 20px;
        }

        p {
            color: #666666;
        }

        code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            color: #d63384;
        }

        ul {
            color: #666666;
        }

        .nav-link {
            color: #333333 !important;
        }

        .nav-link:hover {
            color: #007bff !important;
        }

        #linkForm {
            display: none;
        }

        .form-control {
            background-color: #ffffff;
            color: #333333;
            border: 1px solid #cccccc;
        }

        .form-control:focus {
            background-color: #ffffff;
            color: #333333;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn-outline-success {
            color: #28a745;
            border-color: #28a745;
        }

        .btn-outline-success:hover {
            background-color: #28a745;
            color: white;
        }

        .links-container {
            margin-top: 30px;
        }

        .link-item {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .link-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .link-info {
            flex: 1;
        }

        .link-title {
            font-weight: 600;
            color: #333333;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .link-url {
            font-size: 13px;
            color: #666666;
            word-break: break-all;
        }

        .link-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }

        .link-btn {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .link-btn-visit {
            background-color: #007bff;
            color: white;
        }

        .link-btn-visit:hover {
            background-color: #0056b3;
        }

        .link-btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .link-btn-delete:hover {
            background-color: #c82333;
        }

        .link-btn-copy {
            background-color: #6c757d;
            color: white;
        }

        .link-btn-copy:hover {
            background-color: #5a6268;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .alert {
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            color: #007bff;
        }

        @media (max-width: 768px) {
            .link-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .link-actions {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }

            .link-btn {
                flex: 1;
            }
        }
    </style>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light">
      <!-- ë¡œê³  ì˜ì—­ -->
      <a class="navbar-brand" href="#">
          <img id="logoImage" src="" alt="ì‚¬ì´íŠ¸ ë¡œê³ ">
          <span id="logoText" class="logo-text">Link Store</span>
      </a>
      
      <!-- ë°”ë¡œê°€ê¸° ë§í¬ê°€ ì¶”ê°€ë  ì˜ì—­ -->
      <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mr-auto" id="shortcutLinks">
              <!-- ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë§í¬ê°€ ì¶”ê°€ë©ë‹ˆë‹¤. -->
          </ul>
      </div>
      
      <!-- ì‚¬ìš©ì ì •ë³´ ë° ì¸ì¦ ë²„íŠ¼ -->
      <div id="userInfo" class="user-info" style="display: none;">
          <span class="user-email" id="userEmail"></span>
          <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <div id="authButtons" class="auth-buttons">
          <a href="signin.html">ë¡œê·¸ì¸</a>
          <a href="signup.html">íšŒì›ê°€ì…</a>
      </div>
      
      <!-- ì…ë ¥ í¼ -->
      <form class="form-inline" onsubmit="event.preventDefault(); addLink();" id="linkForm">
        <input class="form-control mr-sm-2" type="url" id="linkUrlInput" placeholder="URLì„ ì…ë ¥í•˜ì„¸ìš”" aria-label="add" required>
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">ì¶”ê°€</button>
      </form>
    </nav>

    <div class="container">
        <h1>ğŸ”— Link Store</h1>
        <p id="description">ë¡œê·¸ì¸ í›„ ë§í¬ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div id="alertContainer"></div>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border" role="status">
                <span class="sr-only">ë¡œë”© ì¤‘...</span>
            </div>
        </div>

        <div id="content">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <p>ë¡œê·¸ì¸í•˜ì—¬ ë§í¬ë¥¼ ê´€ë¦¬í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAsgO9Zu8p3dCA2EBhqy9kgEfyXZZrxwXM",
            authDomain: "link-store-no-login.firebaseapp.com",
            projectId: "link-store-no-login",
            storageBucket: "link-store-no-login.firebasestorage.app",
            messagingSenderId: "368312230339",
            appId: "1:368312230339:web:fdb745c5a9c67313789d76",
            measurementId: "G-YVEX6VVYJ8",
            databaseURL: "https://link-store-no-login-default-rtdb.firebaseio.com"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentUser = null;
        let linksRef = null;

        // ì¸ì¦ ìƒíƒœ ê°ì‹œ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showLoggedInUI(user);
                loadUserLinks(user.uid);
            } else {
                currentUser = null;
                showLoggedOutUI();
            }
        });

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showAlert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showAlert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        };

        // ë§í¬ ì¶”ê°€ í•¨ìˆ˜
        window.addLink = async () => {
            if (!currentUser) {
                showAlert('ë¡œê·¸ì¸ í›„ ë§í¬ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            const urlInput = document.getElementById('linkUrlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showAlert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            // URL ìœ íš¨ì„± ê²€ì‚¬
            try {
                new URL(url);
            } catch (error) {
                showAlert('ìœ íš¨í•œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            try {
                const linkId = Date.now().toString();
                const linkData = {
                    url: url,
                    title: extractDomain(url),
                    createdAt: new Date().toISOString(),
                    isImage: isImageUrl(url)
                };

                const userLinkRef = ref(database, `users/${currentUser.uid}/links/${linkId}`);
                await set(userLinkRef, linkData);

                showAlert('ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                urlInput.value = '';
            } catch (error) {
                showAlert('ë§í¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        };

        // ë§í¬ ì‚­ì œ í•¨ìˆ˜
        window.deleteLink = async (linkId) => {
            if (!currentUser) return;

            if (!confirm('ì´ ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const userLinkRef = ref(database, `users/${currentUser.uid}/links/${linkId}`);
                await remove(userLinkRef);
                showAlert('ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showAlert('ë§í¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
            }
        };

        // ë§í¬ ë³µì‚¬ í•¨ìˆ˜
        window.copyLink = (url) => {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }).catch(() => {
                showAlert('URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        };

        // ì‚¬ìš©ì ë§í¬ ë¡œë“œ
        function loadUserLinks(userId) {
            const userLinksRef = ref(database, `users/${userId}/links`);
            
            onValue(userLinksRef, (snapshot) => {
                const links = [];
                snapshot.forEach((childSnapshot) => {
                    links.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });

                // ìµœì‹  ìˆœì„œë¡œ ì •ë ¬
                links.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                displayLinks(links);
            }, (error) => {
                console.error('ë§í¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            });
        }

        // ë§í¬ í‘œì‹œ
        function displayLinks(links) {
            const contentDiv = document.getElementById('content');

            if (links.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>ì•„ì§ ì €ì¥ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 14px; margin-top: 10px;">ìœ„ì˜ ì…ë ¥ì°½ì— URLì„ ì…ë ¥í•˜ê³  "ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§í¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="links-container">';
            
            links.forEach(link => {
                const date = new Date(link.createdAt).toLocaleDateString('ko-KR');
                html += `
                    <div class="link-item">
                        <div class="link-info">
                            <div class="link-title">${escapeHtml(link.title)}</div>
                            <div class="link-url">${escapeHtml(link.url)}</div>
                            <small style="color: #999;">ì¶”ê°€ë¨: ${date}</small>
                        </div>
                        <div class="link-actions">
                            <button class="link-btn link-btn-visit" onclick="window.open('${escapeHtml(link.url)}', '_blank')">ë°©ë¬¸</button>
                            <button class="link-btn link-btn-copy" onclick="copyLink('${escapeHtml(link.url)}')">ë³µì‚¬</button>
                            <button class="link-btn link-btn-delete" onclick="deleteLink('${link.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentDiv.innerHTML = html;
        }

        // ë¡œê·¸ì¸ëœ UI í‘œì‹œ
        function showLoggedInUI(user) {
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('linkForm').style.display = 'flex';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('description').textContent = 'ì €ì¥ëœ ë§í¬ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.';
        }

        // ë¡œê·¸ì•„ì›ƒëœ UI í‘œì‹œ
        function showLoggedOutUI() {
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('linkForm').style.display = 'none';
            document.getElementById('description').textContent = 'ë¡œê·¸ì¸ í›„ ë§í¬ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <p>ë¡œê·¸ì¸í•˜ì—¬ ë§í¬ë¥¼ ê´€ë¦¬í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // ë„ë©”ì¸ ì¶”ì¶œ í•¨ìˆ˜
        function extractDomain(urlString) {
            try {
                const url = new URL(urlString);
                let domain = url.hostname;
                if (domain.startsWith('www.')) {
                    domain = domain.substring(4);
                }
                return domain;
            } catch (e) {
                return urlString;
            }
        }

        // ì´ë¯¸ì§€ URL í™•ì¸
        function isImageUrl(url) {
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
            const lowerUrl = url.toLowerCase();
            return imageExtensions.some(ext => lowerUrl.includes(ext));
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            // 3ì´ˆ í›„ ìë™ ë‹«ê¸°
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>

  </body>
</html>
