<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ê³µìš© URL ê¸°ë¡ì¥</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">ğŸ”¥ URL ê¸°ë¡ page (ê³µìš©)</a>

      <form class="form-inline" onsubmit="event.preventDefault(); addLink();">
        <input class="form-control mr-2" type="url" id="urlInput" placeholder="URL ì…ë ¥ (https://...)" style="width:300px" required>
        <button class="btn btn-success" type="submit">ì¶”ê°€</button>
      </form>
    </nav>

    <div class="container mt-4">
      <h4>ğŸŒ ì…ë ¥ëœ URL ëª©ë¡</h4>
      <ul id="urlList" class="list-group mb-3"></ul>

      <button class="btn btn-warning mr-2" onclick="deleteSelectedLinks()">ì„ íƒ ì‚­ì œ</button>
      <button class="btn btn-danger" onclick="clearAllLinks()">ëª¨ë‘ ì‚­ì œ</button>
    </div>

    <script type="module">
      // âœ… Firebase SDK import
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import { 
        getFirestore, collection, addDoc, doc, deleteDoc,
        getDocs, onSnapshot, orderBy, query, serverTimestamp, writeBatch 
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

      // âœ… Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: "AIzaSyA6AJRFDj0H2W6EwGBCNiqk8FLK3K_CaGc",
        authDomain: "link-store-final.firebaseapp.com",
        projectId: "link-store-final",
        storageBucket: "link-store-final.appspot.com",
        messagingSenderId: "215371737635",
        appId: "1:215371737635:web:8a80e3401fa9881c29df96",
        measurementId: "G-TD1K7XG1PZ"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const listEl = document.getElementById('urlList');

      // âœ… ì‹¤ì‹œê°„ìœ¼ë¡œ Firestoreì—ì„œ URL ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      function listenUrls() {
        const q = query(collection(db, 'urls'), orderBy('createdAt', 'desc'));
        onSnapshot(q, snapshot => {
          listEl.innerHTML = '';
          let index = 1;
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            addUrlToList(docSnap.id, data.url, index++);
          });
        });
      }

      // âœ… Firestoreì— URL ì¶”ê°€
      async function addLink() {
        const input = document.getElementById('urlInput');
        const newUrl = input.value.trim();
        if (!newUrl) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        try {
          await addDoc(collection(db, 'urls'), {
            url: newUrl,
            createdAt: serverTimestamp()
          });
          input.value = '';
        } catch (err) {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
        }
      }

      // âœ… ë¦¬ìŠ¤íŠ¸ì— URL í‘œì‹œ
      function addUrlToList(docId, url, index) {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center';
        li.dataset.id = docId;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'mr-2';
        checkbox.dataset.docid = docId;

        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.textContent = `${index}. ${url}`;
        a.style.wordBreak = 'break-all';
        a.classList.add('flex-grow-1');

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ì‚­ì œ';
        delBtn.className = 'btn btn-sm btn-outline-danger ml-2';
        delBtn.onclick = () => deleteSingle(docId);

        li.appendChild(checkbox);
        li.appendChild(a);
        li.appendChild(delBtn);
        listEl.appendChild(li);
      }

      // âœ… ë‹¨ì¼ ì‚­ì œ
      async function deleteSingle(docId) {
        if (!confirm('ì´ URLì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await deleteDoc(doc(db, 'urls', docId));
      }

      // âœ… ì„ íƒ ì‚­ì œ
      async function deleteSelectedLinks() {
        const checked = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked'));
        if (checked.length === 0) return alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
        if (!confirm(`${checked.length}ê°œì˜ URLì„ ì‚­ì œí• ê¹Œìš”?`)) return;

        const batch = writeBatch(db);
        checked.forEach(cb => batch.delete(doc(db, 'urls', cb.dataset.docid)));
        await batch.commit();
      }

      // âœ… ì „ì²´ ì‚­ì œ
      async function clearAllLinks() {
        if (!confirm('ì •ë§ ëª¨ë“  URLì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const snap = await getDocs(collection(db, 'urls'));
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(doc(db, 'urls', d.id)));
        await batch.commit();
      }

      // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ Firestore ì‹¤ì‹œê°„ ë°˜ì˜ ì‹œì‘
      listenUrls();

      // âœ… ì „ì—­ í•¨ìˆ˜ ì—°ê²°
      window.addLink = addLink;
      window.deleteSelectedLinks = deleteSelectedLinks;
      window.clearAllLinks = clearAllLinks;
    </script>
  </body>
</html>
